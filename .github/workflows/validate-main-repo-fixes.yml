name: Validate Main Repository Issue #5 Fixes

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      verbose_output:
        description: 'Enable verbose logging for debugging'
        required: false
        default: false
        type: boolean

env:
  # Test environment variables
  POSTGRES_PASSWORD: test_secure_password_123
  SECRET_KEY: test_secret_key_for_testing_purposes_minimum_fifty_characters_required
  NEXTCLOUD_ADMIN_PASSWORD: test_nextcloud_admin_pass
  SUPERADMIN_PASSWORD: test_superadmin_pass
  PGADMIN_DEFAULT_PASSWORD: test_pgadmin_pass

jobs:
  validate-cors-config:
    name: Validate CORS Configuration Fix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository only
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Verify CORS environment variable mapping in docker-compose
        run: |
          echo "ðŸ” Checking docker-compose.yml CORS mapping..."
          
          if grep -q "CORS_ALLOWED_ORIGINS=\${CORS_ALLOWED_ORIGINS}" docker-compose.yml; then
            echo "âœ… CORS_ALLOWED_ORIGINS properly mapped in docker-compose.yml"
          else
            echo "âŒ CORS_ALLOWED_ORIGINS mapping missing in docker-compose.yml"
            exit 1
          fi

      - name: Verify database environment variable mappings
        run: |
          echo "ðŸ” Checking database environment variable mappings in docker-compose.yml..."
          
          required_vars=(
            "POSTGRES_DATABASE=\${POSTGRES_DB:-colmena}"
            "POSTGRES_USERNAME=\${POSTGRES_USER:-colmena}"
            "POSTGRES_HOSTNAME=\${POSTGRES_HOSTNAME:-postgres}"
            "POSTGRES_PORT=\${POSTGRES_PORT:-5432}"
          )
          
          all_found=true
          for var in "${required_vars[@]}"; do
            if grep -q "$var" docker-compose.yml; then
              echo "âœ… Found: $var"
            else
              echo "âŒ Missing: $var"
              all_found=false
            fi
          done
          
          if [ "$all_found" = false ]; then
            echo "âŒ Some database environment variable mappings are missing"
            exit 1
          else
            echo "âœ… All database environment variable mappings are present"
          fi

  validate-workflow-syntax:
    name: Validate Workflow Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository only
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Basic workflow YAML syntax check
        run: |
          echo "ðŸ” Performing basic YAML syntax validation..."
          
          # Check if all workflow files are valid YAML
          for workflow in .github/workflows/*.yml; do
            echo "Checking YAML syntax for $workflow..."
            if python -c "import yaml; yaml.safe_load(open('$workflow'))" 2>/dev/null; then
              echo "âœ… $workflow has valid YAML syntax"
            else
              echo "âŒ YAML syntax error in $workflow"
              exit 1
            fi
          done
          
          echo "âœ… All workflow files have valid YAML syntax"

      - name: Check workflow structure
        run: |
          echo "ðŸ” Checking workflow structure requirements..."
          
          for workflow in .github/workflows/*.yml; do
            echo "Analyzing $workflow structure..."
            
            # Check for required workflow elements
            if grep -q "^name:" "$workflow"; then
              echo "âœ… $workflow has workflow name"
            else
              echo "âš ï¸  $workflow missing name field"
            fi
            
            if grep -q "^on:" "$workflow"; then
              echo "âœ… $workflow has trigger events"
            else
              echo "âŒ $workflow missing trigger events"
              exit 1
            fi
            
            if grep -q "^jobs:" "$workflow"; then
              echo "âœ… $workflow has job definitions"
            else
              echo "âŒ $workflow missing job definitions"
              exit 1
            fi
          done
          
          echo "âœ… All workflows have required structure"

  test-docker-composition:
    name: Test Docker Compose Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository only
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create temporary .env file for validation
        run: |
          echo "ðŸ”§ Creating temporary .env file for docker-compose validation..."
          cat > .env << EOF
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          SECRET_KEY=$SECRET_KEY
          NEXTCLOUD_ADMIN_PASSWORD=$NEXTCLOUD_ADMIN_PASSWORD
          SUPERADMIN_PASSWORD=$SUPERADMIN_PASSWORD
          PGADMIN_DEFAULT_PASSWORD=$PGADMIN_DEFAULT_PASSWORD
          CORS_ALLOWED_ORIGINS=http://localhost:3000 http://127.0.0.1:3000
          POSTGRES_DB=colmena
          POSTGRES_USER=colmena
          POSTGRES_HOSTNAME=postgres
          POSTGRES_PORT=5432
          EOF

      - name: Validate docker-compose.yml syntax
        run: |
          echo "ðŸ” Validating docker-compose.yml syntax..."
          
          if docker compose config --quiet; then
            echo "âœ… docker-compose.yml syntax is valid"
          else
            echo "âŒ docker-compose.yml syntax error detected"
            exit 1
          fi

      - name: Test Docker Compose service definition structure
        run: |
          echo "ðŸ” Analyzing Docker Compose service definitions..."
          
          # Parse docker-compose and check critical services are defined
          if docker compose config | grep -q "colmena-app:"; then
            echo "âœ… colmena-app service defined"
          else
            echo "âŒ colmena-app service missing"
            exit 1
          fi
          
          if docker compose config | grep -q "postgres:"; then
            echo "âœ… postgres service defined"
          else
            echo "âŒ postgres service missing"
            exit 1
          fi
          
          # Check environment variable propagation
          if docker compose config | grep -q "CORS_ALLOWED_ORIGINS"; then
            echo "âœ… CORS_ALLOWED_ORIGINS environment variable present in configuration"
          else
            echo "âŒ CORS_ALLOWED_ORIGINS environment variable not found in configuration"
            exit 1
          fi
          
          if docker compose config | grep -q "POSTGRES_DATABASE"; then
            echo "âœ… POSTGRES_DATABASE environment variable present in configuration"
          else
            echo "âŒ POSTGRES_DATABASE environment variable not found in configuration"
            exit 1
          fi

  test-summary:
    name: Validation Summary  
    runs-on: ubuntu-latest
    needs: [validate-cors-config, validate-workflow-syntax, test-docker-composition]
    if: always()
    steps:
      - name: Generate test summary
        run: |
          cors_result="${{ needs.validate-cors-config.result }}"
          workflow_result="${{ needs.validate-workflow-syntax.result }}"
          docker_result="${{ needs.test-docker-composition.result }}"
          
          echo "# ðŸ§ª Main Repository Issue #5 Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Individual test results
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$cors_result" = "success" ]; then
            echo "| CORS & Database Config | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CORS & Database Config | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$workflow_result" = "success" ]; then
            echo "| Workflow Syntax | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Workflow Syntax | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$docker_result" = "success" ]; then
            echo "| Docker Compose | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker Compose | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall result
          if [ "$cors_result" = "success" ] && [ "$workflow_result" = "success" ] && [ "$docker_result" = "success" ]; then
            echo "## ðŸŽ‰ Overall Result: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "Main repository Issue #5 fixes validated successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Overall Result: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Some validations failed. Please review the test results above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This workflow validates main repository changes only." >> $GITHUB_STEP_SUMMARY
          echo "Submodule-specific fixes require separate validation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY